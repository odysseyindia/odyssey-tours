{{- define "main" }}
{{- .Scratch.Set "layout" "layouts/itinerary/list.html" -}}

<section id="{{ .Scratch.Get "id" | lower }}"> 
  {{ partial "heading.html" . }}
  <div class="columns">
    <div class="intro">
      <div class="column-header">
        <h4>Introduction</h4>
      </div>
      <div>
        <textarea class="intro-content" id="intro-content" name="intro">{{ .Content | plainify }}</textarea>
      </div>
      <div class="column-header">
        <h4>Highlights</h4>
      </div>
      <div>
        <textarea class="intro-content" id="intro-highlights" name="highlights" placeholder="Highlights (each on a new line)">{{ with .Params.highlights }}{{ range . }}{{ printf "%s%s" . "\n" }}{{ end }}{{ end }}</textarea>
      </div>
    </div>
    <div class="to-do-column">
      <div class="column-header">
        <h4>Data</h4>
      </div>
      <div  class="select-flex">
        <div class="custom-select">
          <label class="search-label" for="subtitle">Subtitle</label>
          <input id="intro-subtitle" name="subtitle" value="{{ with .Params.subtitle }}{{ . }}{{ end }}" placeholder="Subtitle">
        </div>
      </div>
      <div  class="select-flex">
        <div class="custom-select">
          <label class="search-label" for="weight">Weight</label>
          <input type="num" tip="0 for FIT and 1-999 for tours" min="0" max="999" id="intro-weight" required name="weight" value="{{ with .Params.weight }}{{ . }}{{ else }}0{{ end }}" placeholder="0"> <!--  onfocusout="activateTour()" -->
        </div>
      </div>

      {{"<!-- interests -->" | safeHTML }}
      <div class="tour-section">
        <h3>Tour theme(s)</h3>
        {{- range (where (where .Site.RegularPages "Section" "experience") ".Params.id" "interest") }}
        <div class="form-check">
          <label class="custom-control-label" for="{{ .Params.translationkey }}">
            <input class="theme custom-control-input" type="checkbox" {{ if in $.Params.themes .Title }}checked {{ end }} value="{{ .Title }}">&nbsp; {{- .Title -}}
          </label>
        </div>
        {{- end }}
      </div>

      <div class="tour-section">
        <label class="tour-region" for="region">Tour region</label>
        <select name="region" id="region">
          <option value="0">Select a region</option>
          {{- range (where (where .Site.Pages "Section" "destinations") ".Params.type" "region") }}
          <option value="{{ .RelPermalink }}" {{if eq .RelPermalink $.Params.region }}selected{{ end }}>{{ .Title }}</option>
          {{- end }}
        </select> 
      </div>
    </div>
  </div>

  <div id="in-progress" class="spinner" role="status">
    <span class="sr-only">In progress...</span>
  </div>

  <div id="alert" class="center alert-box success">
    <strong>Success!</strong> <span ></span> 
  </div>

  <div class="columns">

    <div id="myItinerary" class="overflow-auto">
      <div class="column-header">
        <h4>Itinerary</h4>
      </div>

      {{- $duplicateCities := slice }}
      {{- $x := 0 }}

      {{- $fromDay := 1 }}
      {{- $toDay   := 1 }}

      {{- $fromCity := 0 }}

      {{- range $index,$e := .Params.itinerary }}

      {{- $m := 0 }}
      {{- range $i,$v := .item }}
      {{- with $v.nights }}
      {{- $m = add (int . ) $m }}
      {{- end }}
      {{- end }}

      {{ if gt $m 0 }}
      {{ $toDay = add $toDay $m }}
      {{ else }}
      {{ $toDay = add $toDay 1 }}
      {{ end }}

      <hr class="hr-text" data-content="Day {{ if eq (sub $toDay $fromDay) 1 }} {{ $fromDay }} {{ else }} {{ $fromDay }} - {{ sub $toDay 1 }}{{ end }}">

      {{ $fromDay = $toDay }}

      <div class="containers">
        {{- range $i,$v := .item }}
        <div class="draggable" draggable="true" type="{{ $v.type }}" day={{ $index }} index={{ $i }} url="{{ .url }}">
          <div>
            <i class="icon-{{ $v.type }}"></i>
          </div>
          <div class="program">
            {{- $content := $v.content | default " " }}

            {{- $url     := printf "%s%s" $v.url "_index.md" -}}

            {{- with $.Site.GetPage (string $url) }}
            <div>
              <h4 class="title">{{ with $v.title }}{{ . }}{{ else }}{{ .Title }}{{ end }}</h4>
            </div>
            <div class="content">
              <div class="image">
                {{- if (eq $v.type "city") -}}

                {{- $duplicateCities = $duplicateCities | append (slice $url) }}
                {{- $x = 0 }}

                {{- range $duplicateCities }}
                {{- if eq $url . }}{{ $x = add $x 1 }}
                {{- end }} 

                {{- end -}}

                {{- if eq $x 1 -}}

                {{- range first 1 (.Resources.ByType "image") }}
                {{ partial "image.html" . }}
                {{- end }}

                {{- else -}}

                {{- range first 1 (after (sub $x 1) (.Resources.ByType "image")) }}
                {{ partial "image.html" . }}
                {{- end -}}

                {{- end -}}

                {{- else -}} 

                {{- range first 1 (.Resources.ByType "image") }}
                {{ partial "image.html" . }}
                {{- end -}}

                {{- end }}           
              </div>
              <div class="mr-10 content-text details1"> 
                <div class="content-details">
                  {{- if gt (len $v.content) 0 -}}

                  {{- if in (string $v.content) "\n\n" }}
                  {{ $v.content | markdownify | safeHTML }}
                  {{- else }}
                  <p>{{ $v.content | markdownify | safeHTML }}</p>
                  {{- end }}

                  {{- else if gt (len .Content) 0 -}}

                  {{- if in (string $v.content) "\n\n" }}
                  {{ .Content | markdownify | safeHTML }}
                  {{- else }}
                  <p>{{ .Content | markdownify | safeHTML }}</p>
                  {{- end }}

                  {{- else }}
                  <p></p>
                  {{- end }}
                </div>
                {{- if (eq $v.type "city") }}
                <div class="rowdetails">
                  &nbsp;
                </div>
                {{- else if or (eq $v.type "excursion") (eq $v.type "transfer") }}
                <div class="rowdetails  {{- with $v.date }}show{{ end }}">
                  <div>Date:  </div> 
                  <div class="details" attr="date" value="{{ $v.date }}"> {{- with $v.date }}{{ dateFormat  "02-01-2006" . }}{{ end }}</div>
                  <div>ETD:  </div> 
                  <div class="details" attr="etd" value="{{ $v.etd }}">{{ with $v.etd }} {{ dateFormat  "15:04" . }} {{ end }}</div>
                  <div>Duration:  </div> 
                  <div class="details" attr="duration">{{ $v.duration }}</div>
                </div>
                {{- else if (eq $v.type "hotel") }}
                <div class="rowdetails {{- with $v.checkInDate }}show{{ end }}">
                  <div>Check-in:  </div> 
                  <div class="details" attr="checkInDate" value="{{ $v.checkInDate }}">{{- with $v.checkInDate }}{{ dateFormat  "02-01-2006" . }} {{ end }}</div>
                  <div>ETA: </div> 
                  <div class="details" attr="checkInTime" value="{{ $v.checkInTime }}">{{ with $v.checkInTime }}{{ . }}{{ end }}</div>
                  <div>Check-out: </div> 
                  <div class="details" attr="checkOutDate" value="{{ $v.checkOutDate }}">{{ with $v.checkOutDate }} {{ dateFormat  "02-01-2006" . }}{{ end }}</div>
                  <div>ETD: </div> 
                  <div class="details" attr="checkOutTime" value="{{ $v.checkOutTime }}">{{ with $v.checkOutTime }}{{ . }}{{ end }}</div>
                  <div>Nights: </div> 
                  <div class="details" attr="nights" value="{{ $v.nights }}">{{ $v.nights }}</div>
                </div>
                {{- else if (eq $v.type "flight") }}
                <div class="rowdetails {{ with $v.date }}show{{ end }}">
                  <div>Date:  </div> 
                  <div class="details" attr="date" value="{{ $v.date }}">{{ with $v.date }} {{ dateFormat  "02-01-2006" . }} {{ end }}</div>
                  <div>Flight No:  </div> 
                  <div class="details" attr="flightNo">{{ $v.flightNo }}</div>
                  <div>From: </div> 
                  <div class="details" attr="from"> {{ $v.from }}</div>
                  <div>To:  </div> 
                  <div class="details" attr="to">{{ $v.to }}</div>
                  <div>ETD: </div> 
                  <div class="details" attr="etd" value="{{ $v.etd }}">{{ with $v.etd }} {{ dateFormat  "15:04" . }} {{ end }}</div>
                  <div>ETA:  </div> 
                  <div class="details" attr="eta" value="{{ $v.eta }}">{{ with $v.eta }} {{ dateFormat  "15:04" . }} {{ end }}</div>
                </div>
                {{- else if (eq $v.type "train") }}
                <div class="rowdetails {{ with $v.date }}show{{ end }}">
                  <div>Date:  </div> 
                  <div class="details" attr="date" value="{{ $v.date }}">{{ with $v.date }} {{ dateFormat  "02-01-2006" . }}{{ end }}</div>
                  <div>Train No: </div> 
                  <div class="details" attr="trainNo">{{ $v.trainNo }}</div>
                  <div>Train Name:  </div> 
                  <div class="details" attr="train">{{ $v.train }}</div>
                  <div>From:  </div> 
                  <div class="details" attr="from">{{ $v.from }}</div>
                  <div>To:  </div> 
                  <div class="details" attr="to">{{ $v.to }}</div>
                  <div>ETD:  </div> 
                  <div class="details" attr="etd" value="{{ $v.etd }}">{{ with $v.etd }} {{ dateFormat  "15:04" . }} {{ end }}</div>
                  <div>ETA:  </div> 
                  <div class="details" attr="eta" value="{{ $v.eta }}">{{ with $v.eta }} {{ dateFormat  "15:04" . }} {{ end }}</div>
                </div>
                {{- else if (eq $v.type "car-hire") }}
                <div class="rowdetails {{ with $v.date }}show{{ end }}">
                  <div>Date: </div> 
                  <div class="details" attr="date" value="{{ $v.date }}">{{ with $.date }} {{ dateFormat  "02-01-2006" . }} {{ end }}</div>
                  <div>From:  </div> 
                  <div class="details" attr="city">{{ $v.city }}</div>
                  <div>Days: </div> 
                  <div class="details" attr="duration"> {{ $v.duration }}</div>
                </div>
                {{- end }}  
              </div>            
            </div>
            {{ else }}
            <div class="center alert-box warning">
              {{ $url }} is no longer on file?!
            </div>
            {{ end }}
          </div>
          <div class="editButton">
            <i class="icon-edit-alt"></i>
          </div>
        </div>
        {{- end }}
      </div>
      {{- end }}
      <div id="addDay"></div>
    </div>
    <div class="to-do-column overflow-hidden">
      <div class="main-container">
        <div class="row dossier">
          <div>
            <a href="#0" class="button" onclick="saveItinerary()" data-toggle="tooltip" title="Save"><i class="icon-floppy"></i></a>
            <a href="#0" class="button" id="toggleContent" data-toggle="tooltip" title="Compact" onclick="toggleContent()"><i class="icon-plus-squared"></i></a>
            <a href="#0" class="button" id="toggleCalendar" data-toggle="tooltip" title="Display dates" onclick="toggleCalendar()"><i class="icon-blind"></i></a>
            <a href="#0" class="button" data-toggle="tooltip" title="Insert a day" onclick="insertDay()"><i class="icon-plus"></i></a>
            <a href="#0" class="button" data-toggle="tooltip" title="Delete a day"  onclick="deleteDay()"><i class="icon-minus"></i></a>
            <a href="#0" class="button" data-toggle="tooltip" title="Append a day" onclick="addDay()"><i class="icon-plus"></i></a>
            <a href="#0" class="button showWorkspace" data-toggle="tooltip" title="Workspace" id="toggleWorkspace" onclick="toggleWorkspace()"><i class="icon-wrench"></i></a>
          </div>
        </div>
        <div class="row dossier">
          <div >
            <a href="#0" id="writeButton" class="button" onclick="writeToTour()" data-toggle="tooltip" title="Write to tour"><i class="icon-edit-alt"></i></a>
          </div>
        </div>
      </div>
      <div class="column-header">
        <h4><i class="icon-search"></i>Search</h4>
      </div>
      <div  class="select-flex">
        <div class="custom-select">
          <label for="cities" class="search-label">City</label>
          <select class="maxwidth" id="cities" name="cities">
            <option value="">Select a city</option>
            {{ range ( sort (where (where .Site.Pages "Section" "destinations") ".Params.id" "city") ".Title" "asc" ) }}
            {{ $urlArray := split .Permalink "/" }}
            {{ $path := index $urlArray (sub (len $urlArray) 4) }}
            <option value="{{ .RelPermalink }}">{{ .Title }} {{ if ne $path "destinations" }}, {{ $path | humanize }}{{ end }}</option>
            {{ end }}
          </select>
          <a href="#0" class="button"  onclick="addCity()">
            <i class="select icon icon-city"></i>
          </a>
        </div>
      </div>

{{ partial "modal-select.html" (dict "dot" . "modal" "hotel" "text" "Hotels"  ) }}
{{ partial "modal-select.html" (dict "dot" . "modal" "excursion" "text" "Excursions"  ) }}
{{ partial "modal-select.html" (dict "dot" . "modal" "transfer" "text" "Transfers"  ) }}

      <div id="image"></div>
      <div id="info"></div>

      <div class="column-header">
        <h4><i class="icon-spin3"></i>Workspace</h4>
      </div>

      <div class="containers" id="workspace"></div>
      <div class="trash-column">
        <div class="column-header">
          <h4><i class="icon-trash"  onclick="emptyTrash()"></i> Trash</h4>
        </div>
        <div class="containers" id="trash">
        </div>
      </div>
    </div> 
  </div>

{{ partial "modal.html" (dict "dot" . "modal" "hotel"    ) }}
{{ partial "modal.html" (dict "dot" . "modal" "city"     ) }}
{{ partial "modal.html" (dict "dot" . "modal" "excursion") }}
{{ partial "modal.html" (dict "dot" . "modal" "carhire"  ) }}
{{ partial "modal.html" (dict "dot" . "modal" "flight"   ) }}

  <div id="modal-insert-day" class="modal">
    <div class="modal-content">
      <div class="container">
        <div class="row">
          <div class="cancel close-modal-btn">
            <i class="icon-cancel"></i>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="insertday">Insert a day after day </label>
            <input id="insertday" name="insertday" value="">
          </div>
        </div>
        <div class="row buttons">
          <div>
            <button type="button" class="save" onclick="saveModalDay()">
              <i class="icon-floppy"></i>
              Save
            </button>
          </div>
        </div>
      </div>
    </div>
  </div> 

  <div id="modal-delete-day" class="modal">
    <div class="modal-content">
      <div class="container">
        <div class="row">
          <div class="cancel close-modal-btn">
            <i class="icon-cancel"></i>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="deleteday">Delete a day</label>
            <input id="deleteday" name="deleteday" value="">
          </div>
        </div>
        <div class="row buttons">
          <div>
            <button type="button" class="save" onclick="deleteModalDay()">
              <i class="icon-floppy"></i>
              Save
            </button>
          </div>
        </div>
      </div>
    </div>
  </div> 

  <div class="columns">
    <div class="inclusions">
      <div class="column-header">
        <h4>Inclusions</h4>
      </div>

      <div class="containers inclmargin">
        <h3>Accommodation</h3>
        <div class="program">
          <div class="content">
            <div class="mr-10 content-text details1">  
             
              {{- range $index,$e := .Params.itinerary }} 
              {{- range $i,$v := .item }}
              {{- if (eq $v.type "hotel") }}
              {{ $city := index (split $v.url "/") (sub (len (split $v.url "/")) 4 )  }}
              <div class="incldetails">
                <div>{{ $city | humanize }}, {{ $v.title }}</div> 
                <div class="details" > </div>
              </div>
              {{- end }}  
              {{- end }}
              {{- end }}
            </div>            
          </div>
        </div>

        <h3>Excursions</h3>
        <div class="program">
          <div class="content">
            <div class="mr-10 content-text details1">
            
              {{- range $index,$e := .Params.itinerary }} 
              {{- range $i,$v := .item }}
              {{- if eq $v.type "excursion" }}
              {{ $city := index (split $v.url "/") (sub (len (split $v.url "/")) 4 )  }}
              <div class="incldetails">
                <div>{{ $city | humanize }}, {{ $v.title }}</div> 
              </div>
              {{- end }}
              {{- end }}
              {{- end }}
            </div>
          </div>
        </div>

        <h3>Flights</h3>
        <div class="program">
          <div class="content">
            <div class="mr-10 content-text details1">
              
              {{- range $index,$e := .Params.itinerary }} 
              {{- range $i,$v := .item }}
              {{- if (eq $v.type "flight") }}
              <div class="incldetails">
                <div class="details">{{ $v.flightNo }}</div>
                <div class="details"> {{ $v.from }}/{{ $v.to }}</div>
              </div>
              {{- end }}
              {{- end }}
              {{- end }}
            </div>
          </div>
        </div>


        <h3>Trains</h3>
        <div class="program">
          <div class="content">
            <div class="mr-10 content-text details1"> 
             
              {{- range $index,$e := .Params.itinerary }} 
              {{- range $i,$v := .item }}
              {{- if (eq $v.type "train") }}
              <div class="incldetails">
                <div class="details">{{ $v.train }}</div>
                <div class="details">{{ $v.from }}/{{ $v.to }}</div>
              </div>
              {{- end }}
              {{- end }}
              {{- end }}
            </div>
          </div>
        </div>

        <h3>Car hire</h3>
        <div class="program">
          <div class="content">
            <div class="mr-10 content-text details1"> 
             
              {{- range $index,$e := .Params.itinerary }} 
              {{- range $i,$v := .item }}
              {{- if (eq $v.type "car-hire") }}
              <div class="incldetails">
                <div class="details">{{ $v.city }}</div>
                <div class="details"> {{ $v.duration }}</div>
              </div>
              {{- end }}  
              {{- end }}
              {{- end }}
            </div>            
          </div>
        </div>

        <h3>Transfers</h3>
        <div class="program">
          <div class="content">
            <div class="mr-10 content-text details1"> 
             
              {{- range $index,$e := .Params.itinerary }} 
              {{- range $i,$v := .item }}
              {{- if eq $v.type "transfer" }}
              <div class="incldetails">
                <div class="details"> {{- with $v.date }}{{ dateFormat  "02-01-2006" . }}{{ end }}</div>
                <div class="details">{{ $v.title }} </div> 
              </div>
              {{ end }}
              {{- end }}
              {{- end }}
            </div>            
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

{{- end }}
{{- define "postscript" }}

<script>
  $(document).ready(function(){
    $('[data-toggle="tooltip"]').tooltip();
  });

  import { docLoad } from './js/app/docload.js';
  import { fadeAlert } from './js/app/fadealert.js';


  const source = document.querySelector("#cities");
  const city   = source[source.selectedIndex].value ;
  var   host   = window.location.href.split("/");
        host   = host[0] + "//" + host[2];

  var renewables = document.querySelectorAll(".draggable");

  renewables.forEach(renewable => {
    let url = renewable.getAttribute("url");
    let myClass = renewable.getElementsByClassName("content-text");

    if (url.includes("{{ htmlUnescape .RelPermalink }}")){
      let xhr = new XMLHttpRequest();
      xhr.open('get',url+"/index.json" );
      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) { 
          let data = JSON.parse(xhr.responseText);
          myClass[0].innerText = data.content;
        };
      };
      xhr.send();
    }
  });

  changeCity(city);
  toggleRegion();

  // add EventListeners
  document.getElementById("cities").addEventListener("change", (event) => { changeCity();  });
 //  document.getElementById("hotels").addEventListener("change", (event) => { changeHotel(); });
 //  document.getElementById("excursions").addEventListener("change", (event) => { changeExcursion(); });
  

  document.addEventListener('DOMContentLoaded', (event) => { draggable(); });
  

  var clickClose = document.getElementsByClassName("close-modal-btn");
  var clickEdit  = document.getElementsByClassName("editButton");

  for(var i = 0; i < clickClose.length; i++) {
    (function(index) {
      clickClose[index].addEventListener("click", function() {
        var close = document.getElementsByClassName("modal");
        for(var i = 0; i < close.length; i++) {
          close[index].style.display = "none";
        };
      })
    })(i);
  }

  for(var i = 0; i < clickEdit.length; i++) {
    (function(index) {
      clickEdit[index].addEventListener("click", function() {
        editItem(clickEdit[index].parentElement);
      })
    })(i);
  }


  document.getElementById("save-modal-hotel").addEventListener("click", function(){

    const elements = document.getElementById("modal-hotel");
    const inputs   = elements.getElementsByClassName('input');
    const index    = inputs[0].index;
    const days     = document.getElementById('myItinerary').getElementsByClassName('containers');
    const items    = days[ inputs[0].day ].getElementsByClassName('draggable');
    var   data     = items[index].getElementsByClassName('details');

    const modalContent   = elements.getElementsByClassName('content');
    var content          = items[index].getElementsByClassName('content-details');
    content[0].innerHTML = "<p>"+modalContent[0].value.replace(/\n\n/g, "</p><p>")+"</p>";

    data[0].setAttribute("value", inputs.checkInDate.value ) ; 
    data[1].setAttribute("value", inputs.checkInTime.value ) ;
    data[2].setAttribute("value", inputs.checkOutDate.value) ;
    data[3].setAttribute("value", inputs.checkOutTime.value) ;
    data[4].setAttribute("value", inputs.nights.value) ;
    data[0].innerHTML  = inputs.checkInDate.value ; 
    data[1].innerHTML  = inputs.checkInTime.value ;
    data[2].innerHTML  = inputs.checkOutDate.value ;
    data[3].innerHTML  = inputs.checkOutTime.value ;
    data[4].innerHTML  = inputs.nights.value ;

    elements.style.display = "none";
  });

  document.getElementById("save-modal-excursion").addEventListener("click", function(){

    const elements        = document.getElementById("modal-excursion");
    const inputs          = elements.getElementsByClassName('input');
    const index           = inputs[0].index;
    const days            = document.getElementById('myItinerary').getElementsByClassName('containers');
    const items           = days[ inputs[0].day ].getElementsByClassName('draggable');
    var   data            = items[index].getElementsByClassName('details');

    const modalTitle      = elements.getElementsByClassName('modal-title');
    var title             = items[index].getElementsByClassName('title');
    title[0].innerText    = modalTitle[0].value;

    const modalContent    = elements.getElementsByClassName('content');
    var content           = items[index].getElementsByClassName('content-details');
    content[0].innerHTML  = "<p>"+modalContent[0].value.replace(/\n\n/g, "</p><p>")+"</p>";

    data[0].setAttribute("value", inputs.excursionDate.value ) ; 
    data[1].setAttribute("value", inputs.excursionEtd.value ) ;
    data[2].setAttribute("value", inputs.excursionDuration.value) ;
    data[0].innerHTML  = inputs.excursionDate.value ; 
    data[1].innerHTML  = inputs.excursionEtd.value ;
    data[2].innerHTML  = inputs.excursionDuration.value ;

    elements.style.display = "none";
  });

  document.getElementById("save-modal-city").addEventListener("click", function(){

    const elements = document.getElementById("modal-city");
    const inputs   = elements.getElementsByClassName('input');
    const index    = inputs[0].index;
    const days     = document.getElementById('myItinerary').getElementsByClassName('containers');
    const items    = days[ inputs[0].day ].getElementsByClassName('draggable');

    const modalContent   = elements.getElementsByClassName('content');
    var content          = items[index].getElementsByClassName('content-details');
    content[0].innerHTML = "<p>"+modalContent[0].value.replace(/\n\n/g, "</p><p>")+"</p>";

    elements.style.display = "none";
  });

// allow drag and drop

function draggable(){
  var draggables = document.querySelectorAll('.draggable');
  var containers = document.querySelectorAll('.containers');

  draggables.forEach(draggable => {
    draggable.addEventListener('dragstart',() => {
      draggable.classList.add('dragging');
    });

    draggable.addEventListener('dragend',() => {
      draggable.classList.remove('dragging');
    });
  });

  containers.forEach(container => {
    container.addEventListener('dragover',e => {
      e.preventDefault()
      const afterElement = getDragAfterElement(container,e.clientY)
      const draggable = document.querySelector('.dragging')
      if (afterElement == null){
        container.appendChild(draggable);
      } else {
        container.insertBefore(draggable,afterElement);
      };
    });
  });
};

function toggleRegion (){

  const region = document.getElementById('region');
  var   button = document.getElementById('writeButton');
  const option = region.selectedIndex ;
  
  if ( option > 0 ){
    button.style.display = 'block';
  } else {
    button.style.display = 'none';
  }
};


function getDragAfterElement(container,y){
  const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')]

  return draggableElements.reduce((closest,child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;

    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    } else {
      return closest;
    }
  },{offset: Number.NEGATIVE_INFINITY}).element;

};


function changeCity(){
  const source = document.querySelector("#cities")
  const city   = source[source.selectedIndex].value ;
  const img    = document.getElementById("cityImage");

  if (city){
    displayCity(city);
    displayHotels(city);
    displayExcursions(city);
  // displayCarHire(city);
  // displayFlights(city);
  // displayTrains(city);
}
};


function toggleContent(){
  let days   = document.getElementById('myItinerary').getElementsByClassName('containers');

  let element = document.getElementById('toggleContent');
  if (element.innerText === 'Expand') {
    element.innerHTML = '<i class="icon-minus-squared"></i>Compact';
  } else {
    element.innerHTML = '<i class="icon-plus-squared"></i>Expand';
  }

  for(let i=0;i<days.length;i++) {

    var items   = days[i].getElementsByClassName('content');
    for(let j=0;j<items.length;j++) {
      if (items[j].style.display === "none") {
        items[j].style.display = "flex";
      } else {
        items[j].style.display = "none";
      }
    };
  };
};

function toggleCalendar(){

  let days   = document.getElementById('myItinerary').getElementsByClassName('containers');

  for(let i=0;i<days.length;i++) {

    var items   = days[i].getElementsByClassName('rowdetails');
    for(let j=0;j<items.length;j++) {
      if (items[j].style.visibility === "visible") {
        items[j].style.visibility = "hidden";
      } else {
        items[j].style.visibility = "visible";
      }
    };
  };
};

function toggleWorkspace(){

  let element = document.getElementById('toggleWorkspace');
  element.classList.toggle("showWorkspace");
  if (element.innerText === "Use Itinerary") {
    element.innerHTML = '<i class="icon-wrench"></i>Use Workspace';
  } else {
    element.innerHTML = '<i class="icon-list-numbered"></i>Use Itinerary';
  }
};


function activateTour(){
  var tourRelated = document.getElementsByClassName('tour-section');

  for (var i=0; i<tourRelated.length; i++){
    if (tourRelated[i].value > 0){
      tourRelated[i].style.display = "block";
    } else {
      tourRelated[i].value = 0;
      tourRelated[i].style.display = "none"
    };
  };
};


function addDay(){

  let element  = document.getElementById('addDay');
  let days     = document.getElementById('myItinerary').getElementsByClassName('containers');

  let div   = document.createElement('hr');
  div.className = "hr-text";
  div.dataset.content = "Day "+ (days.length + 1);
  
  element.parentNode.insertBefore(div, element);

  div = document.createElement('div');
  div.className = "containers";
  div.innerHTML = "\n";

  element.parentNode.insertBefore(div, element);

  draggable();
};

function saveItinerary(deleteDay){

  var itinerary    = [];
  
  var themeOptions = document.getElementsByClassName('theme');
  var themes = [];
  for (var i=0; i<themeOptions.length; i++){
    if (themeOptions[i].checked){
      themes.push( themeOptions[i].value );
    };
  };

  var lines        = document.getElementById('intro-highlights').value.split(/\n/);
  var highlights   = [];
  for (var i=0; i<lines.length; i++){
    if ( lines[i].length ){
      highlights.push( lines[i].trim() );
    };
  };

  const days = document.getElementById('myItinerary').getElementsByClassName('containers');
  for(let i=0;i<days.length;i++) {

    if (i != deleteDay){
      var items   = days[i].getElementsByClassName('content');
      for(let j=0;j<items.length;j++) {
        if (items[j].style.display === "none") {
          items[j].style.display = "flex";
        }
      };

      var details = [];
      var items   = days[i].getElementsByClassName('draggable');

      for(let j=0;j<items.length;j++) {

        var obj = {};
        obj.type    = items[j].getAttribute("type");
        obj.url     = items[j].getAttribute("url");
        let title   = items[j].getElementsByClassName('title');
        obj.title   = title[0].innerText.trim().replace(/(`)/gm,"'");
        let content = items[j].getElementsByClassName('content-text');
        obj.content = (content.length != 0) ? content[0].innerText.trim().replace(/(`)/gm,"'") : "";

        let inputs  = items[j].getElementsByClassName('details');
        for(let k=0;k<inputs.length;k++) {
          let attr  = inputs[k].getAttribute("attr");
          let value = inputs[k].getAttribute("value");
          obj[attr] = (value != null) ? value : inputs[k].innerText ;

          if (inputs[k].getAttribute("type") == 'date'){
            const formatYmd = date => date.toISOString().slice(0, 10);
            obj[attr] = (value != null) ? formatYmd(new Date(value)) : inputs[k].innerText ; 
          }

        };

        details.push(obj);
      };

      let object  = {};
      object.day  = i;
      object.item = details;
      itinerary.push( object );
      
    };
  };

  var spinner        = document.getElementById("in-progress");
  const region       = document.getElementById('region');  
  var content        = document.getElementById('intro-content').value;
  var data           = []; 
  data[0]            = {};
  data[0].itinerary  = itinerary;
  data[0].subtitle   = document.getElementById('intro-subtitle').value;
  data[0].weight     = document.getElementById('intro-weight').value;
  data[0].highlights = highlights;
  data[0].themes     = themes;
  data[0].region     = region[region.selectedIndex].value;
  data[1]            = content.replace(/[`]/g, "'");

  spinner.style.display  = 'block';

  docLoad({
    url:    'ajax', 
    method: 'POST',
    apphost: '{{ .Site.Params.appHost }}', 
    data:   JSON.stringify({ 
      "file": {{ .RelPermalink }}+'_index.md', 
      "data": data
    }) 
  })
  .then(
    function(response){ 
      console.log( statusText ); 
    }, 
    function(Error){ 
      console.log( Error ); 
    }
    );
};


function writeToTour(){

  if (confirm("This will republish this itinerary as a tour.\nAre you certain?\n")){

    docLoad({
      url:    'write-to-tour', 
      method: 'POST',
      apphost: '{{ .Site.Params.appHost }}', 
      data:   JSON.stringify({ 
        "file"  : {{ .RelPermalink }}, 
        "region": document.getElementById('region').value,
      })
    })
    .then(
      function(response){ 
        fadeOut('Itinerary saved as a tour');
      }, 
      function(Error){  console.log( Error );       }
    );
  };
};

function displayCity(urldata){

  // const city = urldata.split("/")[(urldata.split("/")).length-2];

  docLoad({url: host+urldata+"index.json" }).then(

    function(response) {

      const citydata = JSON.parse(response);
      const image    = host+urldata+citydata.image;

      if (image){
        document.getElementById("image").style.backgroundImage = 'url("'+image+'")';
      }
      document.getElementById("info").innerHTML = citydata.content;
    }, 

    function(Error) {
      console.log(Error);
    }
    );
};

function displayHotels(city){

  docLoad( {url: host+city+"hotels/index.json"} ).then(

    function(response){

      const data  = JSON.parse(response);
      const items = data.data.items;
      var   sel   = '<option value="">Select a hotel</option>';

      if (items.length > 0) {
        for(let i=0;i<items.length;i++) {
          if ('category' in items[i] && items[i].category.length > 0){ 
            sel += "<option value='"+items[i].permalink+"'>"+items[i].title+"</option>";
          };
        };

        document.getElementById("selectHotels").style.visibility = "visible"; 
        document.getElementById("hotels").innerHTML = sel;
      } else {
        document.getElementById("selectHotels").style.visibility = "hidden";
      };
    }, 
    function(Error) {
      document.getElementById("selectHotels").style.visibility = "hidden";
    }
    );
};

function displayExcursions(city){

  docLoad({url: host+city+"excursions/index.json"}).then(

    function(response) {
      const nonl  = response.replace(/(\n)/gm,"");
      var   data  = JSON.parse(nonl);
      const items = data.data.items;
      var   sel   = '<option value="">Select an excursion</option>';

      if (items.length > 0) {
        for(let i=0;i<items.length;i++) {       
          // if (items[i].transfer != 'true'){
            var option = '{"url":"'+items[i].permalink+'","transfer":'+items[i].transfer+'}';
            sel += "<option value='"+option+"'>"+items[i].title+"</option>"
            document.getElementById("selectExcursions").style.visibility = "visible"; 
            document.getElementById("excursions").innerHTML = sel;
          };
        } else {
          document.getElementById("selectExcursions").style.visibility = "hidden";
        };
      }, 
      function(Error) {
        document.getElementById("selectExcursions").style.visibility = "hidden";
      }
      );
};

function displayCarHire(city){

  docLoad({url: host+city+"car-hire/index.json"}).then(

    function(response) {
      const nonl  = response.replace(/(\n)/gm,"");
      var   data  = JSON.parse(nonl);
      const items = data.data.items;
      var   sel   = '<option value="">Select a car hire</option>';

      if (items.length > 0) {
        for(let i=0;i<items.length;i++) {
          sel += "<option value='"+items[i].permalink+"'>"+items[i].title+"</option>"
        }

        document.getElementById("selectCarHire").style.visibility = "visible"; 
        document.getElementById("selectCars").style.visibility = "visible"; 
        document.getElementById("carhire").innerHTML = sel;
      } else {
        document.getElementById("selectCarHire").style.visibility = "hidden";
        document.getElementById("selectCars").style.visibility = "hidden";
      }
    }, 
    function(Error) {
      document.getElementById("selectCars").style.visibility = "hidden";
    }
    );
};

function displayCars(carhire){

  docLoad({url: carhire+"/index.json"}).then(

    function(response) {
      const nonl  = response.replace(/(\n)/gm,"");
      var   data  = JSON.parse(nonl);
      const items = data.data.items;
      var   sel   = '<option value="">Select a car</option>';

      if (items.length > 0) {
        for(let i=0;i<items.length;i++) {
          sel += "<option value='"+items[i].permalink+"'>"+items[i].title+"</option>"
        }

        document.getElementById("selectCars").style.visibility = "visible"; 
        document.getElementById("cars").innerHTML = sel;
      } else {
        document.getElementById("selectCars").style.visibility = "hidden";
      }
    }, 
    function(Error) {
      document.getElementById("selectCars").style.visibility = "hidden";
    }
    );
};

function displayFlights(city){

  docLoad({url: host+city+"airports/index.json"}).then(

    function(response) {
      const nonl  = response.replace(/(\n)/gm,"");
      var   data  = JSON.parse(nonl);
      const items = data.data.items;
      var   sel   = '<option value="">Select a flight</option>';

      if (items.length > 0) {
        for(let i=0;i<items.length;i++) {
          sel += "<option value='"+items[i].permalink+"'>"+items[i].title+"</option>"
        }

        document.getElementById("selectFlights").style.visibility = "visible"; 
        document.getElementById("flights").innerHTML = sel;
      } else {
        document.getElementById("selectFlights").style.visibility = "hidden";
      }
    }, 
    function(Error) {
      document.getElementById("selectFlights").style.visibility = "hidden";
    }
    );
};

function displayTrains(city){

  docLoad({url: host+city+"railways/index.json"}).then(

    function(response) {
      const nonl  = response.replace(/(\n)/gm,"");
      var   data  = JSON.parse(nonl);
      const items = data.data.items;
      var   sel   = '<option value="">Select a train</option>';

      if (items.length > 0) {
        for(let i=0;i<items.length;i++) {
          sel += "<option value='"+items[i].permalink+"'>"+items[i].title+"</option>"
        }

        document.getElementById("selectTrains").style.visibility = "visible"; 
        document.getElementById("trains").innerHTML = sel;
      } else {
        document.getElementById("selectTrains").style.visibility = "hidden";
      }
    }, 

    function(Error) {
      document.getElementById("selectTrains").style.visibility = "hidden";
    }
    );
};

function addToWorkspace(type,url,text){
  let ws     = document.getElementById('toggleWorkspace');
  const html = '<div class="draggable" draggable="true" type ="'+type+'" url="' + url + '"><i class="icon-'+type+'"></i>&nbsp;<span class="title">' + text+'</span></div>';

  if (ws.className.includes("showWorkspace") === true){
    document.getElementById("workspace").innerHTML += html;
  } else {
    let days   = document.getElementById('myItinerary').getElementsByClassName('containers');
    let length = days.length;
    days[days.length -1 ].innerHTML += html;
  };
  draggable();
};

function addCity(){

  const source = document.querySelector("#cities");
  const i      = source.selectedIndex;
  const url    = source[i].value ;
  const text   = source[i].innerHTML;
  
  if (i > 0) {
    addToWorkspace('city',url,text);
  };
};

function addHotel(){

  const source = document.querySelector("#hotels");
  const ws     = document.getElementById('toggleWorkspace');
  const i      = source.selectedIndex;
  const url    = source[i].value ;
  const text   = source[i].innerHTML;

  if (i > 0) {
    addToWorkspace('hotel',url,text);
  };
};

function addExcursion(){

  const source    = document.querySelector("#excursions");
  const ws        = document.getElementById('toggleWorkspace');
  const i         = source.selectedIndex;
  const value     = JSON.parse(source[i].value );
  const url       = value.url;
  const transfer  = value.transfer;
  const text      = source[i].innerHTML;

  if (transfer == true){
    addToWorkspace('transfer',url,text);
  } else {
    addToWorkspace('excursion',url,text);
  };
};

function addCar(){

  const source    = document.querySelector("#cars")
  const i         = source.selectedIndex;
  const url       = source[i].value ;
  const text      = source[i].innerHTML;

  addToWorkspace('car',url,text);
};

function addFlight(){

  const source    = document.querySelector("#flights")
  const i         = source.selectedIndex;
  const url       = source[i].value ;
  const text      = source[i].innerHTML;

  addToWorkspace('flight',url,text);
};

function addTrain(){

  const source    = document.querySelector("#trains")
  const i         = source.selectedIndex;
  const url       = source[i].value ;
  const train     = source[i].innerHTML;

  addToWorkspace('train',url,city);
};

function emptyTrash(){
  var trash = document.getElementById("trash");
  trash.innerHTML = "";
}

function changeHotel(){
  const source = document.querySelector("#hotels");
  if ( typeof source[source.selectedIndex] !== 'undefined'){
    var url = source[source.selectedIndex].value;
    processRequest(url);
  }
}

function changeExcursion(){
  const source = document.querySelector("#excursions");
  if ( typeof source[source.selectedIndex] !== 'undefined'){
    var url = source[source.selectedIndex].value;
    processRequest(url);
  }
}

function changeCarHire(){
  const source = document.querySelector("#carhire");
  if ( typeof source[source.selectedIndex] !== 'undefined'){
    var url = source[source.selectedIndex].value;
    displayCars(url);
    processRequest(url);
  }
}

function changeCar(){
  const source = document.querySelector("#cars");
  if ( typeof source[source.selectedIndex] !== 'undefined'){
    var url = source[source.selectedIndex].value;
    processRequest(url);
  }
}

function changeFlight(){
  const source = document.querySelector("#flights");
  if ( typeof source[source.selectedIndex] !== 'undefined'){
    var url = source[source.selectedIndex].value;
    processRequest(url);
  }
}

function changeTrain(){
  const source = document.querySelector("#trains");
  if ( typeof source[source.selectedIndex] !== 'undefined'){
    var url = source[source.selectedIndex].value;
    processRequest(url);
  }
}

function processRequest(url){

  docLoad({url: host+url+"index.json"}).then(

    function(response) {

      var data    = JSON.parse(response);
      var content = data.data.content;  
      content     = content.replace(/linebreak/gm,"");

      document.getElementById("info").innerHTML = content;

      if ( data.data.image != undefined){
        const image = 'url("'+host+url+(data.data.image)+'")';
        document.getElementById("image").style["background-image"] = image;
      };
    }, 

    function(Error) {
      console.log(Error);
    }
    );
}

function insertDay(){
  let modal = document.getElementById("modal-insert-day");
  modal.style.display = "block";
  let input = modal.querySelector("input");
  input.value = "";
};

function deleteDay(){
  let modal = document.getElementById("modal-delete-day");
  modal.style.display = "block";
  let input = modal.querySelector("input");
  input.value = "";
};

function deleteModalDay(){

  const modal = document.getElementById("modal-delete-day");

  let index   = modal.querySelector("input").value;
  let doc     = document.getElementById('myItinerary');
  let days    = doc.getElementsByClassName('containers');
  let label   = modal.querySelector("label");

  if (isNaN(index) || index < 1 || index > days.length) {
    label.innerHTML = '<div class="alert">Input not valid</div>';
  } else {   
    modal.style.display = "none";
    saveItinerary(index-1);
  };
};

function saveModalDay(){

  const modal = document.getElementById("modal-insert-day");

  let div;
  let index   = modal.querySelector("input").value;
  let doc     = document.getElementById('myItinerary');
  let days    = doc.getElementsByClassName('containers');
  let label   = modal.querySelector("label");

  if (isNaN(index) || index < 1 || index > days.length) {
    label.innerHTML = '<div class="alert">Input not valid</div>';
  } else {

    for (let i = days.length; i > index; i--) {
      days[i] = days[i-1];
    };

    div = document.createElement('div');
    div.className = "containers";
    div.innerText = "\n";
    days[index].parentNode.insertBefore(div, days[index]);

    modal.style.display = "none";
    saveItinerary();
  };
};

function editItem(obj){

  /* 
  // Do close modal when clicking outside the modal range 

  window.onclick = function(event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  } 
  */

  const day   = obj.getAttribute("day");
  const index = obj.getAttribute("index");
  const url   = obj.getAttribute("url");
  const type  = obj.getAttribute("type");

  var count = (url.match(/\//g) || []).length;

  var modal = document.getElementById("modal-"+type);
  if (type == 'transfer'){
    modal = document.getElementById("modal-excursion");
  };
  modal.style.display = "block";

  var defaultBtn= modal.querySelector(".default-modal-btn");
  if (url.includes("{{ htmlUnescape .RelPermalink }}")){
    defaultBtn.style.display = "block"
  } else {
    defaultBtn.style.display = "none"
  }

  let modalURL          = modal.getElementsByClassName('modal-url');
  let displayURL        = url.split("/");
  modalURL[0].innerText = displayURL[displayURL.length-2];

  let title             = obj.getElementsByClassName('title');
  let modalTitle        = modal.getElementsByClassName('modal-title');
  modalTitle[0].value   = title[0].innerText;

  let rows              = modal.getElementsByClassName('row');
  rows[0].children[0].innerHTML = '<i class="icon-'+type+'"></i>';

  let content           = obj.getElementsByClassName('content-details');
  let modalContent      = modal.getElementsByClassName('content');
  modalContent[0].value = content[0].innerText;
  rows[1].children[0].style.height = 'auto';
  const height          = rows[1].children[0].scrollHeight;
  rows[1].children[0].style.height = height + 'px';

  let inputs      = modal.getElementsByClassName('input');
  inputs[0].day   = day;
  inputs[0].index = index;
  inputs[0].url   = url;

  let data = obj.getElementsByClassName('details');
  for(let i=0;i<inputs.length;i++) {
    if (data[i]) {
      inputs[(i)].value = data[i].innerHTML;
    }
  } 
};

function copyToTours(){

  const source = document.querySelector("#region");
  const region = source[source.selectedIndex].value ;

  var from = host[2];
  var to   = region
alert('from ',from)
alert('to ',to)
  docLoad({
        url:    'copytotours',
        method: 'POST', 
        apphost: '{{ .Site.Params.appHost }}', 
        data: JSON.stringify({
          "from": from,
          "to": to
        })
      })
      .then(

      function(response){
        alert("Copied "+from+" to "+to);
      }, 
      function(Error) {
        alert(Error);
        console.log(Error);
      });

};


window.onload = fadeAlert;
  
</script>

{{- end }}
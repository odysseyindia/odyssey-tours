{{- define "main" }}
{{- .Scratch.Set "layout" "layouts/itinerary/list.html" -}}

<section id="{{ .Scratch.Get "id" | lower }}"> 
  {{ partial "heading.html" . }}
  <div class="container">
    <div class="row">
      <div class="mx-auto w-50 p-3">
        {{ .Content }}
         <div id="message" class="alert " role="alert"></div>
      </div>
    </div>
  </div>

File: {{ .RelPermalink }}
<button class="save" onclick="saveThis()">Save</button>
&nbsp;
<button class="edit" onclick="editThis()">Edit</button>

  <div class="main-container">
    <div class="columns">

      <div id="itinerary">
        {{- range $index,$e := .Params.itinerary }}
        <hr class="hr-text">
        <div class="containers">
          {{- range .url }}
        <div class="draggable" draggable="true" url="{{ . }}">
            {{- with $.Site.GetPage "page" . }}
            <div>
            {{- if in .RelPermalink "excursions"}}
              <i class="icon-camera"></i>
            {{- else if in .RelPermalink "hotels"}}
              <i class="icon-bed"></i>
            {{- else if in .RelPermalink "flights"}}
              <i class="icon-flight"></i>
            {{- else if in .RelPermalink "ferries"}}
              <i class="icon-ferry"></i>
            {{- else if in .RelPermalink "hotels"}}
              <i class="icon-train"></i>
            {{- else if in .RelPermalink "cars"}}
              <i class="icon-cab"></i>
            {{- end }}
            </div>
            <div class="program">
              <div>
                <h4>{{ .Title }}, {{ path.Base .Parent.Parent.RelPermalink | humanize }}</h4>
              </div>
              <div class="content">
                <div class="image">
                  <img class="lazyload" 
                    sizes="(min-width: 35em) 150px, 10vw"
                    data-srcset="{{ .RelPermalink }}{{ .Params.image }} 150w"
                    data-src="{{ .RelPermalink }}{{ .Params.image }}" alt="{{ .Title }}">
                </div>
                <div class="mr-10">
                  {{ .Content }}
                </div>
              </div>
            </div>
            <div class="editButton">
              <i class="icon-edit-alt"></i>
            </div>
            {{- end }}
        </div>
          {{- end }}
        </div>
        {{- end }}
      </div>

      <div class="to-do-column">
        <div class="column-header">
          <h4>Search</h4>
        </div>
        
        <div  class="select-flex">
          <div class="custom-select">
            <label for="cities">City</label>
            <select class="maxwidth" id="cities" name="cities">
              <option value="">Select a city</option>
              {{ range ( sort (where (where .Site.Pages "Section" "states") ".Params.id" "city") ".Title" "asc" ) }}
              <option value="{{ .RelPermalink }}">{{ .Title }} </option>
              {{ end }}
            </select>
          </div>
        </div>
          
        <div class="select-flex">
          <div class="custom-select" id="selectHotels">
            <label for="hotels">Hotels</label>
            <select class="maxwidth" id="hotels" name="hotels">
            </select>
             <i class="select icon icon-bed" onclick="addHotel()"></i>
          </div>
        </div>

        <div class="select-flex">
          <div class="custom-select" id="selectExcursions">
            <label for="excursions">Excursions</label>
            <select class="maxwidth" id="excursions" name="excursions">
            </select>
            <i class="select icon icon-camera"  onclick="addExcursion()"></i>
          </div>
        </div>

        <div id="image"></div>
        <div id="info"></div>

        <div class="column-header">
          <h4>Workspace</h4>
        </div>
        <div class="containers" id="workspace">
        </div>

        <div class="trash-column">
          <div class="column-header">
            <h4>Trash &nbsp;<i class="select icon icon-camera"  onclick="emptyTrash()"></i></h4>
          </div>
          <div class="containers" id="trash">
          </div>
        </div>

      </div> 
    </div>
  </div>
   

<!-- The Modal -->
<div id="modal-lodging" class="modal">
  <div class="modal-content">
    <div class="container">
    <div class="row">
      <div><i class="icon-bed"></i></div>
      <div class="cancel" id="close-btn-lodging"><i class="icon-cancel"></i></div>
    </div>
    <div class="row">
      <div class="input content" contenteditable="true"></div>
    </div>
    <div class="row">
      <div><label for="check-in-date">Check-in</label></div>
      <div><input type="date" name="check-in-date"  placeholder="dd/mm/yyyy" class="input" ></div>
      <div><input type="time" name="check-in-time" placeholder="hh:mm" class="input" ></div>
    </div>
    <div class="row">
      <div><label for="check-out-date">Check-out</label></div>
      <div><input type="date" name="check-out-date" placeholder="dd/mm/yyyy" class="input" ></div>
      <div><input type="time" name="check-out-time" placeholder="hh:mm" class="input" ></div>
    </div>
    <div class="row buttons">
      <div><button class="default" id="default-btn-lodging"><i class="icon-trash"></i>Default</button></div>
      <div><button class="save" id=save-btn-lodging><i class="icon-floppy"></i>Save</button></div>
    </div>
  </div>
  </div>
</div> 

</section>

{{- end }}
{{- define "postscript" }}

<script>

const source = document.querySelector("#cities");
const city   = source[source.selectedIndex].value ;
var   host   = window.location.href.split("/");
var   host   = host[0] + "//" + host[2];

changeCity(city);

// add EventListeners
document.getElementById("cities").addEventListener("change", changeCity);
document.getElementById("hotels").addEventListener("change", changeHotel);
document.getElementById("excursions").addEventListener("change", changeExcursion);
document.addEventListener('DOMContentLoaded', (event) => {
  draggable();
})

var btns = document.querySelectorAll(".editButton");
Array.from(btns).forEach(item => {
  item.addEventListener("click", () => {
    editItem(item.parentElement.getAttribute("url"));
  });
});

// draggables

function draggable(){
  var draggables = document.querySelectorAll('.draggable');
  var containers = document.querySelectorAll('.containers');

  draggables.forEach(draggable => {
    draggable.addEventListener('dragstart',() => {
      draggable.classList.add('dragging');
    })

    draggable.addEventListener('dragend',() => {
      draggable.classList.remove('dragging');
    })

  })

  containers.forEach(container => {
    container.addEventListener('dragover',e => {
      e.preventDefault()
      const afterElement = getDragAfterElement(container,e.clientY)
      const draggable = document.querySelector('.dragging')
      if (afterElement == null){
        container.appendChild(draggable);
      } else {
        container.insertBefore(draggable,afterElement);
      }
     
    })
  })
}

function getDragAfterElement(container,y){
  const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')]

  return draggableElements.reduce((closest,child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    
    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    } else {
      return closest;
    }
  },{offset: Number.NEGATIVE_INFINITY}).element;
}

function saveThis(){

  var data = [];
  let days = document.getElementById('itin').getElementsByClassName('containers');
  
  for(let i=0;i<days.length;i++) {
  
    var urls  = [];
    var items = days[i].getElementsByTagName('div');
    
    for(let j=0;j<items.length;j++) {
     
      var url = items[j].getAttributeNode("url").value;
    
      urls.push(url);
    }
    data.push({"day":i,'url':urls});
  }
  writeData(data);
};

function writeData(data){

  var xhr = new XMLHttpRequest();
  const url='{{ getenv "APP" }}/ajax';
  xhr.open('POST',url,true );
  xhr.setRequestHeader("Content-Type", "application/json");

  xhr.onreadystatechange = function () {
    if (xhr.readyState === 4 && xhr.status === 200) {
       console.log(xhr.responseText);
    }
  };

  xhr.onerror = function (e) {
    console.error(xhr.statusText);
  };

  var data = JSON.stringify({ "file": {{ .RelPermalink }}, "data": data });

  let css = document.getElementById("message");
  css.innerHTML = 'in progress';
  css.classList.add('alert-info');

  xhr.send(data);
}


function changeCity(){
  const source = document.querySelector("#cities")
  const city   = source[source.selectedIndex].value ;
  const img    = document.getElementById("cityImage");

  if (city){
    displayCity(city);
    displayHotels(city);
    displayExcursions(city);
  }
};

function displayCity(url){
  
  const city = url.split("/")[(url.split("/")).length-2];
  // the json url for the city is one step lower in the url tree
  var   newUrl = url.split("/");
  newUrl.pop();
  newUrl.pop();
  
  const path = host+(newUrl.join("/"))+"/index.json";

  var xhr = new XMLHttpRequest();
  xhr.open('get',path );
  xhr.setRequestHeader("Content-Type", "application/json");

  xhr.onreadystatechange = function () {

    if (xhr.readyState === 4 && xhr.status === 200) {

      const data   = JSON.parse(xhr.responseText);
      const cities = data.data.items;

      for(let i=0;i<cities.length;i++) {
        if (cities[i].translationKey == city ){
          citydata = cities[i];
        }
      }

      const img = 'url("'+host+url+citydata.image+'")'
      
      if (img){
      document.getElementById("image").style["background-image"]=img;
      }
      document.getElementById("info").innerHTML = citydata.content;
    }
  };
  xhr.send()
}

function displayHotels(city){
 
  var xhr = new XMLHttpRequest();
  var url=host+city+"hotels/index.json";

  xhr.open('get',url );
  xhr.setRequestHeader("Content-Type", "application/json");

  xhr.onreadystatechange = function () {
    if (xhr.readyState === 4 && xhr.status === 200) {

      const data  = JSON.parse(xhr.responseText);
      const items = data.data.items;
      var   sel   = '<option value="">Select a hotel</option>';

      if (items.length > 0) {
        for(let i=0;i<items.length;i++) {
          sel += "<option value='"+items[i].permalink+"'>"+items[i].title+"</option>";
        }

        document.getElementById("selectHotels").style.visibility = "visible"; 
        document.getElementById("hotels").innerHTML = sel;
      } else {
        document.getElementById("selectHotels").style.visibility = "hidden";
      }
    }
  };
  xhr.send();
};

function displayExcursions(city){

  var xhr = new XMLHttpRequest();
  var url = host+city+"excursions/index.json";
 
  xhr.open('get',url );
  xhr.setRequestHeader("Content-Type", "application/json");

  xhr.onreadystatechange = function () {
    if (xhr.readyState === 4 && xhr.status === 200) {
      const nonl  = xhr.responseText.replace(/(\n)/gm,"");
      var data    = JSON.parse(nonl);
      //data.replace(/^/gm,"\n");
      const items = data.data.items;
      var sel     = '<option value="">Select an excursion</option>';

      if (items.length > 0) {
        for(let i=0;i<items.length;i++) {
          sel += "<option value='"+items[i].permalink+"'>"+items[i].title+"</option>"
        }

        document.getElementById("selectExcursions").style.visibility = "visible"; 
        document.getElementById("excursions").innerHTML = sel;
      } else {
        document.getElementById("selectExcursions").style.visibility = "hidden";
      }
    }
  };
  xhr.send();
};

function addHotel(){

  const source = document.querySelector("#hotels");
  const i      = source.selectedIndex;
  const url    = source[i].value ;
  const hotel  = source[i].innerHTML;
  const html   = '<div class="draggable" draggable="true" url="' + url + '"><i class="icon-bed"></i>&nbsp;' + hotel + '</div>';

  if (i) {
    document.getElementById("workspace").innerHTML += html;
    draggable();
  }
};

function addExcursion(){

  const source    = document.querySelector("#excursions")
  const i         = source.selectedIndex;
  const url       = source[i].value ;
  const excursion = source[i].innerHTML;
  const html      = '<div class="draggable" draggable="true" url="' + url + '"><i class="icon-camera"></i>&nbsp;' + excursion + '</div>'

  if (i) {
    document.getElementById("workspace").innerHTML += html;
    draggable();
  }
};

function emptyTrash(){
  var trash = document.getElementById("trash");
  trash.innerHTML = "";
}

function changeHotel(){
  const source = document.querySelector("#hotels");
  const url    = source[source.selectedIndex].value ;

  processRequest(url);
}

function changeExcursion(){
  const source = document.querySelector("#excursions");
  const url    = source[source.selectedIndex].value ;

  processRequest(url);
}

function processRequest(url){
  var xhr = new XMLHttpRequest();
  xhr.open('get',host+url+"index.json" );
  xhr.setRequestHeader("Content-Type", "application/json");

  xhr.onreadystatechange = function () {
    if (xhr.readyState === 4 && xhr.status === 200) { 
      
      var data    = JSON.parse(xhr.responseText);
      var content = data.data.content;  
      content     = content.replace(/linebreak/gm,"")

      document.getElementById("info").innerHTML = content;

      if ( data.data.image != undefined){
        const image = 'url("'+host+url+(data.data.image)+'")';
        document.getElementById("image").style["background-image"] = image;
      }
    }
  };
  xhr.send();
}

function editItem(url){
 
  var modal = document.getElementById("modal-lodging");
 
  modal.style.display = "block";

  window.onclick = function(event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  } 
  
  var xhr = new XMLHttpRequest();
  xhr.open('get',host+url+"/index.json" );
  xhr.setRequestHeader("Content-Type", "application/json");

  xhr.onreadystatechange = function () {
    if (xhr.readyState === 4 && xhr.status === 200) {
        
      const data  = JSON.parse(xhr.responseText);
      var content = data.content;  
      let modal   = document.getElementById("modal-lodging").getElementsByClassName('input');

      modal[0].url = url;
      modal[0].innerText = content.replace(/linebreak/gm,"");
      modal[2].innerText = data.eta;
      modal[4].innerText = data.etd;
    }
  };

  xhr.send();
}

document.getElementById("close-btn-lodging").addEventListener('click', () => {
  
  document.getElementById("modal-lodging").style.display = "none";
});

document.getElementById("save-btn-lodging").addEventListener('click', () => {
  
  var modal = document.getElementById("modal-lodging").getElementsByClassName('input');
  var url   = modal[0].url;

  var xhr = new XMLHttpRequest();
  xhr.open('get',host+url+"/index.json" );
  xhr.setRequestHeader("Content-Type", "application/json");

  xhr.onreadystatechange = function () {
    if (xhr.readyState === 4 && xhr.status === 200) {
     
      var oldData = JSON.parse(xhr.responseText);
      
      oldData.arrdate = modal[1].value ; 
      oldData.eta     = modal[2].value ;
      oldData.depdate = modal[3].value ;
      oldData.etd     = modal[4].value ;

      if (! url.includes("{{ .RelPermalink }}") ){
        url = "{{ substr .RelPermalink 0 -1 }}" + url;
      } 

      var data = new Object;
      data[1] = modal[0].innerText;
      delete oldData.content;
      delete oldData.permalink;
      delete oldData.this;
      data[0] = oldData;

      saveModal(url,data);
    }
  };
  xhr.send();
});

function saveModal(url, data){
// {{ getenv "APP" }}
  var xhr = new XMLHttpRequest();
  xhr.open('POST','http://localhost:1314/edit', true );
  xhr.setRequestHeader("Content-Type", "application/json");

  xhr.onreadystatechange = function () {
    if (xhr.readyState === 4 && xhr.status === 200) {
       console.log(xhr.responseText);
    }
  };

  xhr.onerror = function (e) {
    console.log(xhr.statusText);
  };

  var data = JSON.stringify({ "file": url, "data": data });
  
  var css  = document.getElementById("message");
  css.innerHTML = 'Writing in progress';
  css.classList.add('alert-info');

  xhr.send(data);
};



function getText() {
  let element = document.querySelector('div[contenteditable]');
  let firstTag = element.firstChild.nodeName;
  let keyTag = new RegExp(
    firstTag === '#text' ? '<br' : '</' + firstTag,
    'i'
  );
  let tmp = document.createElement('p');
  tmp.innerHTML = element.innerHTML
    .replace(/<[^>]+>/g, (m, i) => (keyTag.test(m) ? '{ß®}' : ''))
    .replace(/{ß®}$/, '');
  return tmp.innerText.replace(/{ß®}/g, '\n');
}
</script>

{{- end }}